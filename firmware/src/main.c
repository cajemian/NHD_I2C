/*******************************************************************************
  Main Source File

  Company:
    Microchip Technology Inc.

  File Name:
    main.c

  Summary:
    This file contains the "main" function for a project.

  Description:
    This file contains the "main" function for a project.  The
    "main" function calls the "SYS_Initialize" function to initialize the state
    machines of all modules in the system
 *******************************************************************************/

// *****************************************************************************
// *****************************************************************************
// Section: Included Files
// *****************************************************************************
// *****************************************************************************
#include <stddef.h>                     // Defines NULL
#include <stdbool.h>                    // Defines true
#include <stdlib.h>                     // Defines EXIT_FAILURE
#include "definitions.h"                // SYS function prototypes
#include <string.h>
#include "NHD-2.23-12832UCxx.h"

uint8_t logo[516] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xC0, 0xE0, 0xF0, 0xF0, 0xF0, 0xE0, 0xC0, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00,
  0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x80,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80,
  0x80, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80,
  0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0,
  0xE0, 0x80, 0x83, 0x87, 0x8F, 0x8F, 0x8F, 0xC7, 0xE3, 0x71, 0x71, 0x39, 0x9D, 0xCD, 0xCD, 0xCD,
  0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0xCD, 0x00, 0xFF, 0xFF, 0x1E, 0x38, 0xFF, 0xFF, 0x00, 0x00, 0x00,
  0x00, 0x3F, 0x7F, 0x6D, 0x6D, 0x6D, 0x6D, 0x6D, 0x00, 0x00, 0x00, 0x07, 0x3F, 0x7C, 0x70, 0x7F,
  0x07, 0x03, 0x7F, 0x78, 0x70, 0x3F, 0x0F, 0x01, 0x00, 0x00, 0x00, 0x7F, 0x7F, 0x0C, 0x0C, 0x7F,
  0x7F, 0x00, 0x00, 0x00, 0x40, 0x70, 0x7C, 0x1F, 0x11, 0x13, 0x1F, 0x7C, 0x60, 0x40, 0x00, 0x03,
  0x0F, 0x7C, 0x78, 0x70, 0x3E, 0x0F, 0x03, 0x00, 0x00, 0x00, 0x3F, 0x7F, 0x6D, 0x6D, 0x6D, 0x6D,
  0x6D, 0x6D, 0x00, 0x00, 0x7F, 0x7F, 0x03, 0x0F, 0x1C, 0x70, 0x7F, 0x7F, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x38, 0x7C, 0xFE, 0xFE, 0xFE, 0xFE, 0xFC, 0x7C, 0x31, 0x33, 0x33, 0x33, 0x33, 0x33,
  0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x38, 0x38, 0x1C, 0x0E, 0x07, 0x03, 0x01, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0x18, 0x18, 0x18, 0x38, 0xF0, 0xE0, 0x00, 0x00,
  0x00, 0xF8, 0xF8, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF8, 0xD8, 0xD8, 0xD8, 0xD8, 0xD8, 0x18, 0x00,
  0x00, 0x00, 0xF8, 0xF8, 0x98, 0x98, 0x98, 0x98, 0xF8, 0xF0, 0x00, 0x00, 0x00, 0xF8, 0xF8, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xE0, 0x78, 0x18, 0x78, 0xE0, 0x80, 0x00, 0x00, 0x0C,
  0x3C, 0x70, 0xC0, 0xE0, 0x70, 0x38, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0C, 0x0C, 0x0C, 0x06, 0x07, 0x03, 0x00, 0x00,
  0x00, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x04, 0x0C, 0x0C, 0x0C, 0x0C, 0x0F, 0x07, 0x07, 0x00,
  0x00, 0x00, 0x0F, 0x0F, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0F, 0x0C,
  0x0C, 0x0C, 0x0C, 0x00, 0x00, 0x0E, 0x0F, 0x03, 0x03, 0x03, 0x03, 0x03, 0x0F, 0x0C, 0x00, 0x00,
  0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
typedef enum
{
    SETUP,
    CLEAR,
    DRAW,
    STOP

} DISPLAY_STATES;


int counterms = 0;

DISPLAY_STATES  stateMachine = SETUP;

void sendCommand(uint8_t data){
    int cmdFlg = 0;
    while(cmdFlg == 0){
        cmdFlg = I2C('C', data);
    }
    //cmdFlg = 0;
}

void TC3_Callback_InterruptHandler(TC_TIMER_STATUS status, uintptr_t context)
{   //TODO Change to 10ms and toggle Valves
    /* Toggle LED, Visible Tick */     
    counterms++; 

}

int main ( void )
{
    //Start Interrupt
    TC3_TimerCallbackRegister(TC3_Callback_InterruptHandler, (uintptr_t)NULL);
    /* Initialize all modules */
    SYS_Initialize ( NULL );
    
    //Enable 100ms timer
    //TC3_TimerStart();
    //int i = 0;
    //int CMDflg = 0;
    int sendData = 0;
    while(1)
    {
        I2C_Reset_Set();            //Reset High
        switch(stateMachine){
            case SETUP:
                for(int i = 0; i < SETUP_COMMANDS; i++){
                    sendCommand(setupData[i]);
                }
                stateMachine = CLEAR;
            break;
            
            case CLEAR:
                for(int i = 0; i < 4; i++){
                    //Start Page
                    sendCommand(0xB0 + i);
                    
                    //Set StartColumn 
                    sendCommand(0x04);
                    sendCommand(0x10);
                    
                    for(int i = 0; i < 132; i++){
                        while(sendData == 0){
                            sendData = I2C('D', 0x00);
                        }
                        sendData = 0;
                    }
                }
                stateMachine = DRAW;
            break;
            case DRAW:
                //setPageAddress(0, 3);
                sendCommand(0x22);
                sendCommand(0x00);
                sendCommand(0x03);
                //setColumnAddress(4, 131);
                sendCommand(0x21);
                sendCommand(0x04);
                sendCommand(0x83);
                //setAddressingMode
                sendCommand(0x20);
                sendCommand(0x00);
                //write data
                  for(int i = 0; i < 516; i++){
                    while(sendData == 0){
                        sendData = I2C('D', logo[i]);
                    }
                    sendData = 0;
                  }
                stateMachine = STOP;
            case STOP:
                break;
        }

    }

    return ( EXIT_FAILURE );
}


/*******************************************************************************
 End of File
*/

